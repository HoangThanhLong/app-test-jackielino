<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TMA AI Agent - SPA</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
 <link rel="stylesheet" href="public/customer.css">
</head>
<body>
   
  <div class="auth-container">
    <!-- Pills navs -->
    <ul class="nav nav-pills nav-justified mb-0" id="ex1" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="tab-login" data-bs-toggle="pill" href="#pills-login" role="tab"
          aria-controls="pills-login" aria-selected="true">Đăng nhập</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="tab-register" data-bs-toggle="pill" href="#pills-register" role="tab"
          aria-controls="pills-register" aria-selected="false">Đăng ký</a>
      </li>
    </ul>

    <!-- Pills content -->
    <div class="tab-content">
      <!-- Login Tab -->
      <div class="tab-pane fade show active" id="pills-login" role="tabpanel" aria-labelledby="tab-login">
        <form id="loginForm" novalidate>
  <div class="text-center mb-4">
    <p class="mb-2">Đăng nhập bằng:</p>
    <button type="button" class="btn btn-link btn-floating mx-1">
      <i class="bi bi-facebook"></i>
    </button>
    <button type="button" class="btn btn-link btn-floating mx-1">
      <i class="bi bi-google"></i>
    </button>
    <button type="button" class="btn btn-link btn-floating mx-1">
      <i class="bi bi-twitter"></i>
    </button>
    <button type="button" class="btn btn-link btn-floating mx-1">
      <i class="bi bi-github"></i>
    </button>
  </div>

  <p class="text-center mb-4">hoặc:</p>

  <!-- Email input -->
  <div class="form-outline mb-4">
    <input type="email" id="loginName" class="form-control" placeholder=" " required />
    <label class="form-label" for="loginName">Email đăng nhập</label>
    <div class="invalid-feedback" id="loginNameError"></div>
  </div>

  <!-- Password input -->
  <div class="form-outline mb-4">
    <input type="password" id="loginPassword" class="form-control" placeholder=" " required />
    <label class="form-label" for="loginPassword">Mật khẩu</label>
    <div class="invalid-feedback" id="loginPasswordError"></div>
  </div>

  <!-- 2 column grid layout -->
  <div class="row mb-4">
    <div class="col-md-6 d-flex justify-content-center">
      <!-- Checkbox -->
      <div class="form-check mb-3 mb-md-0">
        <input class="form-check-input" type="checkbox" value="" id="loginCheck" checked />
        <label class="form-check-label" for="loginCheck"> Ghi nhớ đăng nhập </label>
      </div>
    </div>
    <div class="col-md-6 d-flex justify-content-center">
      <a href="#!">Quên mật khẩu?</a>
    </div>
  </div>

  <!-- Submit button -->
  <button type="button" class="btn btn-danger mb-4" id="loginButton">Đăng nhập</button>
</form>
      </div>

      <!-- Register Tab -->
      <div class="tab-pane fade" id="pills-register" role="tabpanel" aria-labelledby="tab-register">
        <form>
          <div class="text-center mb-4">
            <p class="mb-2">Đăng ký bằng:</p>
            <button type="button" class="btn btn-link btn-floating mx-1">
              <i class="bi bi-facebook"></i>
            </button>
            <button type="button" class="btn btn-link btn-floating mx-1">
              <i class="bi bi-google"></i>
            </button>
            <button type="button" class="btn btn-link btn-floating mx-1">
              <i class="bi bi-twitter"></i>
            </button>
            <button type="button" class="btn btn-link btn-floating mx-1">
              <i class="bi bi-github"></i>
            </button>
          </div>

          <p class="text-center mb-4">hoặc:</p>

          <!-- Name input -->
          <div class="form-outline mb-4">
            <input type="text" id="registerName" class="form-control" placeholder=" " required />
            <label class="form-label" for="registerName">Họ </label>
          </div>

          <!-- Username input -->
          <div class="form-outline mb-4">
            <input type="text" id="registerUsername" class="form-control" placeholder=" " required />
            <label class="form-label" for="registerUsername">Tên </label>
          </div>

          <!-- Email input -->
          <div class="form-outline mb-4">
            <input type="email" id="registerEmail" class="form-control" placeholder=" " required />
            <label class="form-label" for="registerEmail">Email</label>
          </div>

          <!-- Password input -->
          <div class="form-outline mb-4">
            <input type="password" id="registerPassword" class="form-control" placeholder=" " required />
            <label class="form-label" for="registerPassword">Mật khẩu</label>
          </div>

          <!-- Repeat Password input -->
          <div class="form-outline mb-4">
            <input type="password" id="registerRepeatPassword" class="form-control" placeholder=" " required />
            <label class="form-label" for="registerRepeatPassword">Nhập lại mật khẩu</label>
          </div>

          <!-- Checkbox -->
          <div class="form-check d-flex justify-content-center mb-4">
            <input class="form-check-input me-2" type="checkbox" value="" id="registerCheck" checked
              aria-describedby="registerCheckHelpText" />
            <label class="form-check-label" for="registerCheck">
              Tôi đồng ý với các điều khoản
            </label>
          </div>

          <!-- Submit button -->
          <button type="button" class="btn btn-danger mb-3">Đăng ký</button>
          
        </form>
      </div>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', () => {
  // Đợi toàn bộ DOM tải xong trước khi chạy mã
  const loginForm = document.getElementById('loginForm'); // Lấy form đăng nhập
  const loginButton = document.getElementById('loginButton'); // Lấy nút đăng nhập

  // Kiểm tra xem form và nút có tồn tại
  if (loginButton && loginForm) {
    // Gắn sự kiện click cho nút đăng nhập
    loginButton.addEventListener('click', async () => {
      // Lấy input email và mật khẩu từ form
      const emailInput = document.getElementById('loginName');
      const passwordInput = document.getElementById('loginPassword');
      const email = emailInput.value.trim(); // Lấy giá trị email, loại bỏ khoảng trắng
      const password = passwordInput.value.trim(); // Lấy giá trị mật khẩu, loại bỏ khoảng trắng

      // Xóa trạng thái xác thực trước đó để tránh hiển thị lỗi cũ
      emailInput.classList.remove('is-invalid', 'is-valid');
      passwordInput.classList.remove('is-invalid', 'is-valid');
      document.getElementById('loginNameError').textContent = ''; // Xóa thông báo lỗi email
      document.getElementById('loginPasswordError').textContent = ''; // Xóa thông báo lỗi mật khẩu

      let isValid = true; // Biến theo dõi trạng thái xác thực

      // Kiểm tra email
      if (!email) {
        emailInput.classList.add('is-invalid');
        document.getElementById('loginNameError').textContent = 'Vui lòng nhập email.';
        isValid = false;
      } else if (!/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(email)) {
        emailInput.classList.add('is-invalid');
        document.getElementById('loginNameError').textContent = 'Email không đúng định dạng.';
        isValid = false;
      } else {
        emailInput.classList.add('is-valid');
      }

      // Kiểm tra mật khẩu
      if (!password) {
        passwordInput.classList.add('is-invalid');
        document.getElementById('loginPasswordError').textContent = 'Vui lòng nhập mật khẩu.';
        isValid = false;
      } else if (password.length < 6) {
        passwordInput.classList.add('is-invalid');
        document.getElementById('loginPasswordError').textContent = 'Mật khẩu phải có ít nhất 6 ký tự.';
        isValid = false;
      } else {
        passwordInput.classList.add('is-valid');
      }

      // Nếu tất cả xác thực đều hợp lệ, gọi API
      if (isValid) {
        try {
          // Vô hiệu hóa nút để ngăn click nhiều lần
          loginButton.disabled = true;
          loginButton.textContent = 'Đang đăng nhập...'; // Cập nhật văn bản nút

          // Gửi yêu cầu POST đến API
          const response = await fetch('https://app.jackielino-dev.io.vn/auth.php/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });

          // Phân tích phản hồi JSON từ API
          const data = await response.json();
          console.log(data);

          if (data.status === 'ok') {
            // Nếu đăng nhập thành công
            alert(data.message || 'Đăng nhập thành công!');

            // Lưu thông tin phiên đăng nhập
            const expirationTime = new Date().getTime() + 2 * 24 * 60 * 60 * 1000; // 2 ngày (48 giờ) tính bằng mili giây
            localStorage.setItem('isLoggedIn', 'true');
            localStorage.setItem('loginExpiration', expirationTime);
            localStorage.setItem('userEmail', email); // Lưu email để xác thực (tùy chọn)

            // Chuyển hướng đến trang dashboard
            window.location.href = '/pages/dashboard';
          } else {
            // Nếu đăng nhập thất bại, hiển thị lỗi
            alert(data.message || data.error || 'Đăng nhập thất bại. Vui lòng kiểm tra email hoặc mật khẩu.');
            emailInput.classList.add('is-invalid');
            passwordInput.classList.add('is-invalid');
            document.getElementById('loginNameError').textContent = 'Thông tin đăng nhập không đúng.';
            document.getElementById('loginPasswordError').textContent = 'Thông tin đăng nhập không đúng.';
          }
        } catch (error) {
          // Xử lý lỗi mạng hoặc server
          console.error('Error:', error);
          alert('Đã xảy ra lỗi khi kết nối đến server. Vui lòng thử lại sau.');
        } finally {
          // Khôi phục nút sau khi hoàn tất
          loginButton.disabled = false;
          loginButton.textContent = 'Đăng nhập';
        }
      }
    });
  }
});

// Kiểm tra trạng thái đăng nhập khi tải trang
window.addEventListener('load', () => {
  const isLoggedIn = localStorage.getItem('isLoggedIn');
  const expirationTime = localStorage.getItem('loginExpiration');

  if (isLoggedIn === 'true' && expirationTime) {
    const currentTime = new Date().getTime();
    if (currentTime < expirationTime) {
      // Nếu phiên vẫn hợp lệ, chuyển hướng đến dashboard
      window.location.href = '/pages/dashboard';
    } else {
      // Nếu phiên đã hết hạn, xóa thông tin đăng nhập
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('loginExpiration');
      localStorage.removeItem('userEmail');
    }
  }
});
      
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>